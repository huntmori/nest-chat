<html>
<head>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs" crossorigin="anonymous"></script>
  <script type="module">

    const app = {
      'access_token': '',
      'refresh_token': ''
    }
    let socket;
    const btnLogin = document.querySelector('#btnLogin');
    btnLogin.addEventListener('click', async () => {
      console.log('btnLogin clicked');
      const accessToken = await login();
      console.log(accessToken);
    })

    const btnConnect = document.querySelector('#btnConnect');
    btnConnect.addEventListener('click', () => {
      console.log('btnConnect clicked');
      connect();
    })

    const btnDisconnect = document.querySelector('#btnDisconnect');
    btnDisconnect.addEventListener('click', () => {
      disconnect();
    })

    const btnEmit = document.querySelector('#btnEmit');
    btnEmit.addEventListener('click', () => {
      const eventName = document.querySelector('#txtEventName').value;
      const eventData = document.querySelector('#txtEventData').value;
      
      if (!socket || !socket.connected) {
        alert('먼저 소켓을 연결해주세요.');
        return;
      }

      try {
        // 입력값이 JSON 형태라면 객체로 변환하여 전송, 아니면 문자열 그대로 전송
        const payload = eventData.startsWith('{') || eventData.startsWith('[') 
          ? JSON.parse(eventData) 
          : eventData;
        
        socket.emit(eventName, payload);
        txtLogs.value += `[Sent] Event: ${eventName}, Data: ${eventData}\n`;
      } catch (e) {
        // JSON 파싱 실패 시 문자열로 전송
        socket.emit(eventName, eventData);
        txtLogs.value += `[Sent] Event: ${eventName}, Data: ${eventData}\n`;
      }
    });

    const txtLogs = document.querySelector('#txtLogs');

    function disconnect() {
      socket.disconnect();
    }
    async function login() {
      console.log('login');
      txtLogs.value += 'login\n';
      const api = 'http://localhost:3000/auth/login';
      const response = await fetch(api, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          "email": document.querySelector('#txtEmail').value,
          "password": document.querySelector('#txtPassword').value
        })
      })

      const data = await response.json();
      txtLogs.value += `login response: ${JSON.stringify(data)}\n`;

      const accessToken = data.data.access_token;
      const refreshToken = data.data.refresh_token;
      app.access_token = accessToken;
      app.refresh_token = refreshToken;

      return accessToken;
    }

    function connect() {
      socket= io(document.querySelector('#txtNamespace').value || 'ws://localhost:3000/chat', {
        extraHeaders: {
          Authorization: `Bearer ${app.access_token}`,
        }
      });

      socket.on('events', function(data) {
        txtLogs.value += `events: ${JSON.stringify(data)}\n`;
        console.log('event', data);
      });
      socket.on('message', function(data) {
        txtLogs.value += `message: ${JSON.stringify(data)}\n`;
        console.log('message', data);
      });
      socket.on('exception', function(data) {
        txtLogs.value += `exception: ${JSON.stringify(data)}\n`;
        console.log('exception', data);
      });
      socket.on('disconnect', function() {
        txtLogs.value += 'Disconnected\n';
        console.log('Disconnected');
      });
      socket.on('connect', function() {
        txtLogs.value += 'Connected\n';

        socket.emit('events', { test: 'test' });
        socket.emit('message', { test: 'test' });
        socket.emit('identity', { identity: 'identity' });
      });
    }
  </script>
</head>

<body>
  <div>
    <div>
      <label for="txtNamespace">Namespace</label>
      <input type="text" id="txtNamespace" name="namespace" value="ws://localhost:3000/chat"/>
    </div>
    <div>
      <label for="txtEmail">Email</label>
      <input type="text" id="txtEmail" name="email" value="kknd5050@bbz.link"/>
    </div>
    <div>
      <label for="txtPassword">password</label>
      <input type="password" id="txtPassword" name="password" value="1q2w3e"/>
    </div>
    <div>
      <button id="btnLogin">Login</button>
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect">Disconnect</button>
    </div>
    <hr/>
    <div style="background-color: #f0f0f0; padding: 10px; margin-bottom: 10px;">
      <strong>Custom Emit</strong><br/>
      <label for="txtEventName">Event Name:</label>
      <input type="text" id="txtEventName" value="events" placeholder="이벤트명"/><br/>
      <label for="txtEventData">Data (String or JSON):</label><br/>
      <textarea id="txtEventData" style="width: 100%; height: 300px;">{"test": "data"}</textarea><br/>
      <button id="btnEmit" style="background-color: #4CAF50; color: white;">Emit Event</button>
    </div>
  </div>
  <div style="width: 100%; height: 300px; border: 1px solid #ccc; overflow: auto;">
    <textarea id="txtLogs" style="width: 100%; height: 100%; resize: none;"></textarea>
  </div>
</body>
</html>